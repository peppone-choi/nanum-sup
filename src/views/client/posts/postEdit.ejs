<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê²Œì‹œê¸€ ìˆ˜ì •</title>
    <link rel="stylesheet" href="/static/styles/pages/posts/postEdit.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <div id="wrap">
      <div class="inner"><%- include('../../_layouts/header-menu-w',{ category: category }) %></div>

      <div class="inner container">
        <form id="postWriteForm" class="flex-column-center">
          <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œì‘ -->
          <label for="category" class="category">
            <!-- <span>ì¹´í…Œê³ ë¦¬ ì„ íƒ</span> -->
            <select name="category" id="category" class="category" required>
              <option disabled>ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
              <!-- <% if (post.category.id && post.category.title) { %> -->
              <option selected value="<%= post.category.id %>"><%= post.category.title %></option>
              <!-- <% } %> -->
            </select>
          </label>
          <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ ë -->

          <!-- ì œëª© ì…ë ¥ ì‹œì‘ -->
          <label for="title" class="title">
            <!-- <span>ì œëª©</span> -->
            <input type="text" name="title" id="title" required placeholder="ì œëª©ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”." value="<%= post.title %>" />
          </label>
          <!-- ì œëª© ì…ë ¥ ë -->
          <!-- <div id="summernote"></div> -->

          <!-- ë‚´ìš© ì…ë ¥ ì‹œì‘ -->

          <div class="contentArea">
            <!-- <div id="content" contenteditable="true" placeholder="ê²Œì‹œê¸€ ë‚´ìš©ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”."></div> -->
            <textarea name="content" id="content" maxlength="2000" placeholder="ê²Œì‹œê¸€ ë‚´ìš©ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”."><%= post.content %></textarea>
            <div class="upload">
              <label for="file">
                <img src="/static/images/upload-btn-gray.svg" class="formImg" alt="íŒŒì¼ì—…ë¡œë“œë²„íŠ¼" />
              </label>
              <input type="file" id="file" multiple />
            </div>
          </div>

          <!-- ë‚´ìš© ì…ë ¥ ë -->

          <!-- ì‘ì„± (ì œì¶œ) ë²„íŠ¼ -->
          <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
        </form>
      </div>
    </div>

    <script>
      const $form = document.getElementById("postWriteForm");
      const formImg = document.querySelector(".formImg");
      const file = document.getElementById("file");
      // fileì— ê¸°ì¡´ì˜ ì´ë¯¸ì§€ì™€ ë¹„ë””ì˜¤ íŒŒì¼ì„ ë‹´ì•„ë‘˜ ë°°ì—´
      let videoUrl = "";
      const IMAGE_MAX = 4;
      const VIDEO_MAX = 1;
      const imageArray = [];

      // ê¸°ì¡´ì˜ ì´ë¯¸ì§€ì™€ ë¹„ë””ì˜¤ íŒŒì¼ì„ ë°°ì—´ì— ë‹´ì•„ë‘ê¸°
      const post = `<%- JSON.stringify(post) %>`;
      const postObj = JSON.parse(post);
      postObj.pictures?.forEach((image) => {
        const imageFile = new File([image], image, { type: "image/png" });
        imageArray.push(imageFile);
      });
      const upload = document.querySelector(".upload");
      const video = postObj.video ? new File([postObj.video], postObj.video, { type: "video/mp4" }) : "";
      upload.appendChild(document.createElement("div")).innerHTML = imageArray.map((file) => file.name).join("<br>") + "<br>" + videoUrl;

      // íŒŒì¼ ì—…ë¡œë“œ ì‹œ íŒŒì¼ëª… í‘œì‹œ
      file.addEventListener("change", async (e) => {
        e.preventDefault();
        const files = e.target.files;

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileType = file.type.split("/")[0];

          if (fileType === "image") {
            if (imageArray.length < IMAGE_MAX) {
              imageArray.push(file);
            } else {
              alert("ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 4ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
              break;
            }
          } else if (fileType === "video") {
            if (videoUrl === "") {
              videoUrl = file.name;
            } else {
              alert("ë¹„ë””ì˜¤ëŠ” ìµœëŒ€ 1ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
              break;
            }
          }
        }
        // íŒŒì¼ ì¶”ê°€ ì‹œ íŒŒì¼ëª… í‘œì‹œ ë° íŒŒì¼ í•˜ë‚˜í•˜ë‚˜ ë§ˆë‹¤ ì‚­ì œ ë²„íŠ¼ ìƒì„±
        const imageFileNames = imageArray.map((file) => file.name).join("<br>");
        const videoFileNames = videoUrl;
        const fileNames = `${imageFileNames}<br>${videoFileNames}`;

        upload.appendChild(document.createElement("div")).innerHTML = fileNames;
      });

      const $postWriteForm = document.getElementById("postWriteForm");

      const $deleteButton = document.getElementById("delete-button");

      const cookies = document.cookie.split(";").reduce((acc, cookie) => {
        const [key, value] = cookie.split("=");
        acc[key.trim()] = decodeURIComponent(value);
        return acc;
      }, {});

      const token = `${cookies.accessToken}`;

      $postWriteForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const images = imageArray;
        const video = videoUrl;
        const videoFile = videoUrl ? new File([videoUrl], videoUrl, { type: "video/mp4" }) : "";
        const imageFormData = new FormData();
        const fileFormData = new FormData();
        const imagesUrl = [];
        post.pictures?.forEach((image) => {
          imagesUrl.push(image);
        });
        images.forEach((image) => {
          if (image instanceof File) {
            imageFormData.append("filenames", image);
          }
        });
        if (videoFile instanceof File) {
          fileFormData.append("filename", videoFile);
        }

        const imageRes = await fetch("/api/upload/images", {
          method: "post",
          headers: {
            authorization: token,
          },
          body: imageFormData,
        });
        const imageResData = await imageRes.json();
        const urls = imageResData.urls;
        urls.forEach((url) => {
          imagesUrl.push(url);
        });

        let videoResUrl = "";
        if (video !== "") {
          const videoRes = await fetch("/api/upload/video", {
            method: "post",
            headers: {
              authorization: token,
            },
            body: fileFormData,
          });
          videoResUrl = (await videoRes.json()).url;
        }

        const title = document.getElementById("title").value;
        const content = document.getElementById("content").value;
        const category = document.getElementById("category").value;
        console.log(title, content, category);
        try {
          const res = await fetch("/api/posts/<%= post.postId %>", {
            method: "put",
            headers: {
              "Content-Type": "application/json",
              authorization: token,
            },
            body: JSON.stringify({
              title,
              content,
              category,
              pictures: imagesUrl,
              video: videoResUrl,
            }),
          });

          if (!res.status === 204) {
            throw new Error("ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }

          location.href = "/posts/<%= post.postId %>";
        } catch (error) {
          console.error("ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      });

      $deleteButton?.addEventListener("click", async () => {
        try {
          const res = await fetch("/api/posts/<%= post.postId %>", {
            method: "delete",
            headers: {
              "Content-Type": "application/json",
              authorization: token,
            },
          });

          if (!res.ok) {
            throw new Error("ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }

          location.href = "/posts";
        } catch (error) {
          console.error("ê²Œì‹œê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      });

      // ì¹´í…Œê³ ë¦¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const categories = [
        {
          categoryId: "66f247f68d1dffeca42e1a10",
          title: "ğŸ‘¨â€ğŸ’» ê°œë°œ ë‚˜ëˆ”ìˆ²",
        },
        {
          categoryId: "66f24da1aa8f0092f375865a",
          title: "ğŸ¬ ì˜í™” ë‚˜ëˆ”ìˆ²",
        },
        {
          categoryId: "66f264b40d793036e28637e8",
          title: "ğŸœ ë§›ì§‘ ë‚˜ëˆ”ìˆ²",
        },
        {
          categoryId: "66f28957453960e94559ae7d",
          title: "ğŸ’­ ì¡ë‹´ ë‚˜ëˆ”ìˆ²",
        },
        {
          categoryId: "66f28a54453960e94559ae80",
          title: "ğŸ’ª ìš´ë™ ë‚˜ëˆ”ìˆ²",
        },
      ];

      // select ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
      const $category = document.getElementById("category");

      // ì˜µì…˜ ì¶”ê°€ í•˜ê¸°
      categories.forEach((category) => {
        const option = document.createElement("option");
        option.value = category.categoryId; // value ì†ì„±ì— categoryId í• ë‹¹í•´ì£¼ê¸°
        option.textContent = category.title; // í‘œì‹œí•  í…ìŠ¤íŠ¸ì— title í• ë‹¹í•´ì£¼ê¸°
        $category.appendChild(option); // select ìš”ì†Œì— ì˜µì…˜ ì¶”ê°€
      });
    </script>
  </body>
</html>
