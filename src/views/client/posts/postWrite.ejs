<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Í≤åÏãúÍ∏Ä ÏûëÏÑ±</title>
    <link rel="stylesheet" href="/static/styles/pages/posts/postWrite.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <div id="wrap">
      <div class="inner"><%- include('../../_layouts/header-w') %></div>

      <div class="inner container">
        <form id="postWriteForm" class="flex-column-center">
          <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù ÏãúÏûë -->
          <label for="category" class="category">
            <select name="category" id="category" class="category" required>
              <option disabled selected>Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù</option>
              <% if (post.category.id && post.category.title) { %>
              <option value="<%= post.category.id %>"><%= post.category.title %></option>
              <% } %>
            </select>
          </label>
          <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù ÎÅù -->

          <!-- Ï†úÎ™© ÏûÖÎ†• ÏãúÏûë -->
          <label for="title" class="title">
            <input type="text" name="title" id="title" required placeholder="Ï†úÎ™©ÏùÑ ÏûëÏÑ±Ìï¥ Ï£ºÏÑ∏Ïöî." />
          </label>
          <!-- Ï†úÎ™© ÏûÖÎ†• ÎÅù -->

          <!-- ÎÇ¥Ïö© ÏûÖÎ†• ÏãúÏûë -->
          <div class="contentArea">
            <textarea name="content" id="content" maxlength="2000" placeholder="Í≤åÏãúÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûëÏÑ±Ìï¥ Ï£ºÏÑ∏Ïöî."></textarea>
            <div class="upload">
              <label for="file">
                <img src="/static/images/upload-btn-gray.svg" class="formImg" alt="ÌååÏùºÏóÖÎ°úÎìúÎ≤ÑÌäº" />
              </label>
              <input type="file" id="file" multiple />
            </div>
          </div>
          <!-- ÎÇ¥Ïö© ÏûÖÎ†• ÎÅù -->

          <!-- ÏûëÏÑ± (Ï†úÏ∂ú) Î≤ÑÌäº -->
          <button type="submit">ÏûëÏÑ± ÏôÑÎ£å</button>
        </form>
      </div>
    </div>

    <script>
      const $form = document.getElementById("postWriteForm");
      const formImg = document.querySelector(".formImg");
      const file = document.getElementById("file");

      // ÌååÏùº ÏóÖÎ°úÎìú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
      formImg.addEventListener("click", (e) => {
        e.preventDefault();
        file.click();
      });

      const imageArray = [];
      const videoArray = [];
      const IMAGE_MAX = 4;
      const VIDEO_MAX = 1;

      // ÌååÏùº ÏóÖÎ°úÎìú Ïãú ÌååÏùºÎ™Ö ÌëúÏãú
      file.addEventListener("change", async (e) => {
        e.preventDefault();
        const files = e.target.files;

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileType = file.type.split("/")[0];

          if (fileType === "image") {
            if (imageArray.length < IMAGE_MAX) {
              imageArray.push(file);
            } else {
              alert("Ïù¥ÎØ∏ÏßÄÎäî ÏµúÎåÄ 4Í∞úÍπåÏßÄ ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.");
              break;
            }
          } else if (fileType === "video") {
            if (videoArray.length < VIDEO_MAX) {
              videoArray.push(file);
            } else {
              alert("ÎπÑÎîîÏò§Îäî ÏµúÎåÄ 1Í∞úÍπåÏßÄ ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.");
              break;
            }
          }
        }
      });

      $form.addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const title = $form.title.value;
          const content = $form.content.value;
          const cookies = document.cookie.split(";").reduce((acc, cookie) => {
            const [key, value] = cookie.split("=");
            acc[key.trim()] = decodeURIComponent(value);
            return acc;
          }, {});

          const imageFormData = new FormData();
          imageArray.forEach((file) => imageFormData.append("filenames", file));

          const videoFormData = new FormData();
          videoArray.forEach((file) => videoFormData.append("filenames", file));

          const imageFileRes = await fetch("/api/upload/images", {
            method: "POST",
            body: imageFormData,
          });
          const videoFileRes = await fetch("/api/upload/video", {
            method: "POST",
            body: videoFormData,
          });

          const imageFileData = (await imageFileRes.json()).urls;
          const videoFileData = (await videoFileRes.json()).url;

          const token = `${cookies.accessToken}`;
          const $category = document.getElementById("category");

          const res = await fetch("/api/posts", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              authorization: token,
            },
            body: JSON.stringify({
              categoryId: $category.value,
              title,
              content,
              pictures: imageFileData || null,
              videos: videoFileData || null,
            }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.details);

          //   location.href = `/posts/${data.postId}`;
        } catch (error) {
          alert("Í≤åÏãúÍ∏Ä ÏûëÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.", error.message);
        }
      });

      // Ïπ¥ÌÖåÍ≥†Î¶¨ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
      const categories = [
        { categoryId: "66f247f68d1dffeca42e1a10", title: "üë®‚Äçüíª Í∞úÎ∞ú ÎÇòÎàîÏà≤" },
        { categoryId: "66f24da1aa8f0092f375865a", title: "üé¨ ÏòÅÌôî ÎÇòÎàîÏà≤" },
        { categoryId: "66f264b40d793036e28637e8", title: "üçú ÎßõÏßë ÎÇòÎàîÏà≤" },
        { categoryId: "66f28957453960e94559ae7d", title: "üí≠ Ïû°Îã¥ ÎÇòÎàîÏà≤" },
        { categoryId: "66f28a54453960e94559ae80", title: "üí™ Ïö¥Îèô ÎÇòÎàîÏà≤" },
      ];

      // ÏòµÏÖò Ï∂îÍ∞ÄÌïòÍ∏∞
      const $category = document.getElementById("category");
      categories.forEach((category) => {
        const option = document.createElement("option");
        option.value = category.categoryId;
        option.textContent = category.title;
        $category.appendChild(option);
      });
    </script>
  </body>
</html>
